name: Terraform Plan on PR

on:
  pull_request:
    branches:
      - main
      - release

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  terraform-plan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.11.0"

      - name: Install TFLint
        run: |
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

      - name: Install tfsec
        run: |
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

      - name: Generate tfvars from SSM Parameter Store
        run: |
          echo "Fetching terraform-variables from SSM..."

          # Default
          ENVIRONMENT="dev"

          if [[ "${GITHUB_HEAD_REF}" == "release" || "${GITHUB_REF}" == "refs/heads/release" ]]; then
            ENVIRONMENT="prod"
          fi
          echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV

          PARAMETER_NAME="/hello-birthday-api/$ENVIRONMENT/terraform-variables"
          terraform_vars_json=$(aws ssm get-parameter --name "$PARAMETER_NAME" --query "Parameter.Value" --output text)
          mkdir -p "${ENVIRONMENT}"
          echo "$terraform_vars_json" > "${ENVIRONMENT}/${ENVIRONMENT}.tfvars.json"

        working-directory: terraform

      - name: Terraform Init
        run: |
          if [[ "${{ github.base_ref }}" == "main" ]]; then
            terraform init -backend-config=../infrastructure/backends/backend-dev.hcl
          elif [[ "${{ github.base_ref }}" == "release" ]]; then
            terraform init -backend-config=../infrastructure/backends/backend-prod.hcl
          else
            echo "Unsupported target branch for plan"
            exit 1
          fi
        working-directory: terraform

      - name: Terraform Fmt
        run: terraform fmt -check -recursive

      - name: Terraform Validate
        run: terraform validate

      - name: Run TFLint
        run: |
          tflint --init
          tflint --call-module-type=all

      - name: Run tfsec (Security Checks) #disabled some tfsec tests for DEV
        run: tfsec --config-file terraform/envs/dev/.tfsec.yaml terraform/envs/dev/

      - name: Run tfsec for Prod
        run: tfsec terraform/envs/dev/

      - name: Terraform Plan
        id: plan
        run: |
          if [[ "${{ github.base_ref }}" == "main" ]]; then
            terraform plan -no-color -var-file=dev/dev.tfvars.json -out=tfplan | tee plan.txt
          elif [[ ${{ github.base_ref }} == "release" ]]; then
            terraform plan -var-file=prod/prod.tfvars.json -out=tfplan | tee plan.txt
          fi
        working-directory: terraform

      - name: Set Plan File Name
        run: |
          echo "${{ github.sha }}" > plan-filename.txt

      - name: Upload tfplan and plan-filename.txt to S3
        run: |
          aws s3 cp terraform/tfplan s3://hello-birthday-api-tfstate/tfplans/$ENVIRONMENT/${{ github.sha }}.tfplan
          aws s3 cp plan-filename.txt s3://hello-birthday-api-tfstate/tfplans/$ENVIRONMENT/plan-filename.txt

      - name: Comment Terraform Plan on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: terraform-plan
          path: terraform/plan.txt
